# 后台任务管理模块需求文档

## 1. 背景与目标

当前 AI 执行长任务会阻塞对话流程，影响交互体验。需要引入后台任务管理模块，使长时间任务可异步运行，前台对话保持响应。

**目标：**
- 提供简单的后台任务创建与管理能力，类似 Go 协程的轻量化体验
- 创建任务时传入“工作主题/内容要求”，返回任务 ID
- 查询任务状态，返回“执行中/结束”等状态以及最近 10 条运行日志
- 可主动结束任务，并明确返回是否成功
- 每个任务动态创建一个类似 Master Agent 的执行体，独立完成工作

## 2. 范围

**范围内：**
- 任务创建、查询、停止的能力与接口定义
- 任务生命周期与状态机规范
- 任务日志采集与查询规范
- 动态 Agent 的创建、上下文与资源边界
- 与现有消息/会话系统的集成要求

**范围外：**
- 任务调度优先级与队列系统（如需，后续版本扩展）
- 任务结果的多渠道推送策略细节（先只返回查询结果）
- 多租户隔离与计费策略（后续扩展）

## 3. 核心概念

- **后台任务（Task）**：异步运行的工作单元，包含输入、状态、日志与结果
- **任务执行体（Task Agent）**：任务级别的动态 Agent，基于 Master Agent 能力创建
- **任务日志（Task Log）**：任务执行过程的结构化日志，仅保留最近 N 条

## 4. 功能需求

### 4.1 发起后台任务

**输入：**
- `work`: 任务内容要求（文本）
- 自动将当前对话的 `session_key`、`channel`、`chat_id` 传递进去（用于上下文关联）

**输出：**
- `task_id`: 全局唯一任务 ID
- `status`: 初始状态（默认 `running`）

**行为要求：**
- 创建任务时立即返回，不阻塞当前对话
- 任务执行由独立 Task Agent 处理
- 任务输入需完整记录，便于追踪

### 4.2 查询后台任务

**输入：**
- `task_id`

**输出：**
- `status`: `running` / `finished` / `failed` / `stopped`
- `last_logs`: 最近 10 条运行日志（按时间正序）
- 可选 `result_summary`: 任务完成后的摘要结果（若已完成）

**行为要求：**
- 查询应为常量时间复杂度或接近常量时间
- 日志数量固定为最近 10 条，避免过大负载

### 4.3 结束后台任务

**输入：**
- `task_id`

**输出：**
- `success`: 是否成功结束
- `status`: 结束后的状态（`stopped` 或原状态）

**行为要求：**
- 若任务已完成，返回 `success=false` 并保持原状态
- 若任务执行中，需触发取消并确保资源释放

## 5. 任务生命周期与状态机

**状态：**
- `pending`: 已创建但未开始
- `running`: 执行中
- `finished`: 正常结束
- `failed`: 执行失败
- `stopped`: 手动停止

**状态流转：**
- `pending -> running -> finished`
- `running -> failed`
- `running -> stopped`

**要求：**
- 状态流转必须原子化，避免并发覆盖
- 状态变更必须记录日志

## 6. 日志与可观测性

**日志要求：**
- 日志为结构化文本，统一中文描述
- 仅保留最近 10 条（先进先出）
- 包含时间戳与阶段信息（如“启动/执行/完成/失败/停止”）

**指标建议（可选）：**
- 任务创建数、完成数、失败数、停止数
- 平均执行耗时

## 7. 动态 Agent 规范

**创建原则：**
- 每个任务创建一个 Task Agent，能力与 Master Agent 对齐
- Task Agent 使用独立上下文与会话隔离
- Task Agent 不影响主对话的历史记录

**资源限制：**
- 最大并发任务数（配置项）
- 单任务最大执行时长（配置项）
- 单任务最大工具调用次数（配置项）

## 8. 接口形态（需求级）

统一对外提供三类能力，可在实现时映射为工具或 API：
- `start_task(work, context)` → `task_id`
- `get_task(task_id)` → `status + last_logs + result_summary`
- `stop_task(task_id)` → `success + status`

## 9. 安全与权限

- 仅允许任务创建者查询与停止任务
- 若无身份信息，默认使用会话键作为隔离边界

## 10. 错误处理

- 无效 ID：返回明确错误信息
- 资源不足：返回错误并拒绝创建任务
- 执行异常：记录失败原因并设置 `failed`

## 11. 配置项

- `max_concurrent_tasks`
- `task_timeout_seconds`
- `task_log_capacity`（默认 10）
- `task_max_tool_iterations`

## 12. 验收标准

- 可创建后台任务并立即返回任务 ID
- 可通过任务 ID 查询状态与最近 10 条日志
- 可通过任务 ID 停止运行中的任务
- 任务独立执行，主对话不被阻塞
